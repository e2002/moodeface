<!doctype html>
<!--
  This file is part of the "moOdefAce" distribution (https://github.com/e2002/moodeface).
  Copyright (c) 2023 e2002 <e2002@bk.ru>.

  This program is free software: you can redistribute it and/or modify  
  it under the terms of the GNU General Public License as published by  
  the Free Software Foundation, version 3.

  This program is distributed in the hope that it will be useful, but 
  WITHOUT ANY WARRANTY; without even the implied warranty of 
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU 
  General Public License for more details.

  You should have received a copy of the GNU General Public License 
  along with this program. If not, see <http://www.gnu.org/licenses/>.
-->
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>moOde fAce</title>
    <link id="favicon" rel="shortcut icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABjFBMVEUdHSQeHiUfHyYgICghISkiIiojIyskJC0lJS4mJi8nJzAoKDIpKTMqKjQrKzUsLDYcHCIdHSMjIiokJCwlJS0mJi4oKDEpKTIqKjMrKzQaGiAbGyEkIysnJy8kIywYGB4ZGR8nJi8uLTcqKTImJS4nJzEXFxwYGB0xMTs0ND8yMTwtLTcpKDEVFRoWFhsXFx0wMDo1NUEzMj8xMDsjIywUFBgVFRkhICgsKzYxMT0+PklNTVc6OkY4N0M6OkQqKTMSEhYSEhceHiJGRkpPTlRKSlJVVV5sbHRZWWJtbXZmZm9vbncxMTolJC0iIikQEBQsLDBiYmVnZmp8fIFycnl8fINSUluGhox3d36Pj5SDg4g4OEAPDxMXFxskIygqKS86OkFCQko9PUZNTVVHRk9AP0c9PUQkIyoODhEPDxISERYZGB4gICcjIiscHCMMDA8NDRARERUdHCMLCw4UExgYFx0UFBkVFhsZGR4JCQwKCg0RERQTExgICAoJCQsQEBMICAkKCgwTExf///+AZqd4AAAAAWJLR0SD/LTP0gAAAAlwSFlzAAAvPgAALz4BnzQjrAAAAAd0SU1FB+IHHA8nEPOZwSIAAAEOSURBVBjTY2BgZGJmYWVj5+Dk4ubh5eNnEBBkZGJhFWITFhHlEhOXkGSQkhZgkpEVlWNjEwYrYpBXkGZUVFJSVmEDKZJVZVBTV2CQ1dDU0tYRAQsx6OrpS4sYGBoaGfNziZiYCDOYmunqm1tYWlnb2NrZcwqzMTg4Ojm7uLq5e3h6ebv5+Pox+PsHBAYFh4SGhUdERkWzMjPExMTGxSckJiUnpaSmpTMyMmRkxmRl57BzsOcy5UlJSwsw5BdkFKox5DAVScnr68srSDEU5xdklpSq65mZlumWq6lXMFRWFRdkFhZWFxY61JTp6qkx1NZVVuUXFGRk1hc6OAJVMTTU1jVWAfVlxPgXOjSZ6gIARvI5FqJekxgAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDctMjhUMTU6Mzk6MTYrMDI6MDDOjx+NAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTA3LTI4VDE1OjM5OjE2KzAyOjAwv9KnMQAAAFd6VFh0UmF3IHByb2ZpbGUgdHlwZSBpcHRjAAB4nOPyDAhxVigoyk/LzEnlUgADIwsuYwsTIxNLkxQDEyBEgDTDZAMjs1Qgy9jUyMTMxBzEB8uASKBKLgDqFxF08kI1lQAAAABJRU5ErkJggg==">
    <style>
        * { 
          margin: 0;
          padding: 0;
          box-sizing: border-box;
          user-select: none;
        }
        html {
            height: 100%;
            overflow: hidden;
        }
        body {
          height: 100%;
          background-color: #000;
        }
        body {
          color: #fff;
          font-family: Tahoma, Helvetica, Arial, Sans, sans-serif;
          padding: 0;
          margin: 0;
          overflow: hidden;
        }
        .transform{
          transform: translateZ(0);
        }
        #backdropwrap, #screensaver{
          position: absolute;
          top: 0; right: 0; bottom: 0; left: 0;
          overflow: hidden;
        }
        #backdrop {
          min-width: calc(100vw + 10vmin);
          min-height: calc(100vh + 10vmin);
          max-width: unset;
          transform: translate(-50%,-50%);
          background-position: 50%;
          position: relative;
          top: 50vh;
          left: 50vw;
          position: relative;
          filter: blur(3.5vmin);
        }
        #backdrop[src=""]{
          visibility: hidden;
        }
        #screensaver {
          background: rgba(0,0,0,0.85);
          backdrop-filter: blur(0.9vmin);
          -webkit-backdrop-filter: blur(0.9vmin);
          z-index: 15;
          cursor: none;
        }
        #screensaver #timerwrapper {
          position: absolute;
          left: 50%;
          bottom: 17.5vmin;
          transform: translateX(-50%);
        }
        #screensaver #timerwrapper #timer {
          font-size: 25vmin;
          color: #e3d25f;
        }
        #screensaver #timerwrapper #timers {
          font-size: 25vmin;
          color: #fff;
          margin-left: 0;
        }
        #screensaver #timerwrapper #timers::before{
          content: ':';
        }
        #screensaver.hidden {
          display: none;
        }
        .button {
          cursor: pointer;
          -webkit-tap-highlight-color: rgba(0,0,0,0);
        }
        #player {
          background: rgba(0,0,0,0.5);
          padding: 5vmin;
          position: relative;
          box-sizing: border-box;
          max-width: 100%;
          max-height: 100%;
          height: 100%;
          display: flex;
          flex-direction: column;
        }
        #playeroverlay {
          position: absolute;
          top: 0; right: 0; bottom: 0; left: 0;
          background: rgba(0,0,0,0.5);
          z-index: 20;
          -webkit-tap-highlight-color: rgba(0,0,0,0);
        }
        #playeroverlay .bnitem{
          margin: 3vmin;
          backdrop-filter: blur(0.9vmin);
          -webkit-backdrop-filter: blur(0.9vmin);
        }
        #playeroverlay .bnitem#playlistmode {
          position: absolute;
          bottom: 0;
        }
        #title {
          overflow: hidden;
          margin-bottom: 2vmin;
          height: 9vmin;
        }
        #title div {
          font-size: 8vmin;
          font-weight: bold;
          text-transform: uppercase;
          color: #e3d25f;
          white-space: nowrap;
        }
        #song {
          overflow: hidden;
          margin-bottom: 3vmin;
          height: 7vmin;
        }
        #song div {
          font-size: 5vmin;
          font-weight: bold;
          text-transform: uppercase;
          color: rgba(255,255,255,0.6);
          color: #a9a9a9;
          white-space: nowrap;
        }
        hr {
          border: 0;
          border-bottom: rgba(255,255,255,0.2) 2px solid;
          margin-bottom: 2.5vmin;
        }
        #infowrapper {
          display: flex;
          align-items: flex-end;
          padding-bottom: 1vmin;
        }
        #playstate {
          font-size: 10vmin;
          line-height: 10vmin;
          font-weight: bold;
          text-transform: uppercase;margin-left: -0.3vmin;
        }
        #timer {
          font-size: 15vmin;
          font-weight: bold;
          color: rgba(255,255,255,0.95);
        }
        #timerwrapper {
          display: flex;
          align-items: flex-start;
        }
        #timers {
          font-size: 8vmin;
          font-weight: bold;
          color: #e3d25f;
          color: rgba(255,255,255,0.4);
          color: #e3d25f;
          margin-left: 1.5vmin;
        }
        #playerprogresswrapper{
          margin-right: 3.5vmin;
          position: relative;
          padding-bottom: 1.5vmin;
        }
        #playerprogresswrapper.hidden{
          visibility: hidden;
        }
        #playerprogressbg{
          background: rgba(0,0,0,0.2);
          height: 1vmin;
          margin: 1vmin 0 0 0;
        }
        #playerprogress {
          height: 1vmin;
          background: rgba(255,255,255,0.3);
          width: 0%;
        }
        #playerprogressduration {
          position: absolute;
          right: 0;
          bottom: 0;
          padding-bottom: 3.5vmin;
          color: rgba(255,255,255,0.6);
          font-size: 4vmin;
          font-weight: bold;
        }
        #playerprogresshandle {
          position: absolute;
          left: 0; right: 0; bottom: 0;
          cursor: pointer;
          z-index: 9;
          height: 10vmin;
        }
        #bitrate {
          font-size: 7vmin;
          font-weight: bold;
          color: #e3d25f;
          flex: 1;
          padding-left: 4.5vmin;
        }
        #genrewrap{
          flex: 1;
        }
        #genre{
          text-transform: lowercase;
          font-size: 4vmin;
          height: 4vmin;
          font-weight: bold;
          margin-top: 1.0vmin;
          margin-right: 1.5vmin;
          color: #e3d25f;
          overflow: hidden;
        }
        #centerwrap {
          display: flex;
          flex: 1;
          position: relative
        }
        #playerleft{
          display: flex;
          flex-direction: column;
          flex: 1;
        }
        #cover {
          width: 54vmin;
          height: 54vmin;
          background-position: center center;
          background-repeat: no-repeat;
          background-size: cover;
          cursor: pointer;
          position: relative;
        }
        #coverimg {
          width: 100%;
          height: 100%;
        }
        #coverimg[src=""]{
          visibility: hidden;
        }
        #favorite {
          padding: 2vmin;
          width: 10vmin;
          height: 10vmin;
          stroke: #fff;
          position: absolute;
          right: 0;
          bottom: 0;
          fill: none;
          stroke-width: 2px;
        }
        #favorite.active{
          stroke: red;
          fill: red;
        }
        #volumebg {
          background: rgba(0,0,0,0.2);
          height: 3vmin;
        }
        #volume {
          height: 3vmin;
          width: 0%;
          background: #e3d25f;
        }
        #volumetext {
          color: rgba(255,255,255,0.6);
          font-size: 7vmin;
          font-weight: bold;
        }
        #ipaddr {
          color: rgba(255,255,255,0.2);
          font-size: 4vmin;
          font-weight: bold;
        }
        #playlist {
          position: absolute;
          left: 0; top: 0; bottom : 0;
          transform: translateX(-60vmin);
          -webkit-transform: translateX(-60vmin);
          display: flex;
        }
        #playlist .hidden {
          display: none;
        }
        #playlistcontent {
          width: 60vmin;
          background-color: rgba(255,255,255,0.55);
          max-height: 100%;
          overflow: hidden;
          overflow-y: auto;
          -ms-overflow-style: none;
          scrollbar-width: none;
          box-shadow: inset -1.5vmin 0 2vmin -1vmin rgba(0,0,0,0.7);
        }
        #playlistcontent::-webkit-scrollbar {
          display: none;
        }
        #playlisthandle {
          width: 5vmin;
          background-color: transparent;
          cursor: pointer;
        }
        body.slide-in #playlist {
          animation: slide-in 0.2s forwards;
          -webkit-animation: slide-in 0.2s forwards;
          z-index: 10;
        }
        body.slide-out #playlist {
          animation: slide-out 0.2s forwards;
          -webkit-animation: slide-out 0.2s forwards;
          z-index: 8;
        }
        body.slide-in #player {
          animation: player-in 0.2s forwards;
          -webkit-animation: player-in 0.2s forwards;
        }
        body.slide-out #player {
          animation: player-out 0.2s forwards;
          -webkit-animation: player-out 0.2s forwards;
        }
        .plitem {
          height: 10vmin;
          padding-left: 12vmin;
          background-position: left center;
          background-size: 10vmin 10vmin;
          background-repeat: no-repeat;
          cursor: pointer;
          display: flex;
          flex-direction: column;
          justify-content: center;
          border-bottom: rgba(0,0,0,0.15) 1px solid;
          margin-bottom: 0px;
          padding-bottom: 0px;
          font-family: Helvetica, Arial, Sans, sans-serif;
        }
        #playlistlist.hovered .plitem:hover, #playlists.hovered .plitem:hover {
          background-color: rgba(255,255,255,0.25);
        }
        .plitem.active {
          background-color: rgba(0,0,0,0.15);
        }
        .plitem.active .plname {
          color: #fff;
        }
        #playlistlist.notitles .plname{
          pointer-events: none;
        }
        .plname {
          white-space: nowrap;
          font-size: 3.2vmin;
          font-weight: bold;
          color: rgba(0,0,0,0.85);
          margin-right: 2vmin;
          overflow: hidden;
        }
        .plgenre {
          white-space: nowrap;
          font-size: 2vmin;
          color: rgba(0,0,0,0.55);
          margin-right: 2vmin;
          overflow: hidden;
        }
        .plitem.active .plgenre {
          color: #FFF;
        }
        #bottomnav {
          height: 30vmin;
          padding: 4vmin 1vmin 2vmin 1vmin;
          padding-bottom: 2vmin;
          margin-right: -2.0vmin;
          background: linear-gradient(rgba(0,0,0,0.0), rgba(0,0,0,0.4), rgba(0,0,0,0.4));
          position: absolute;
          bottom: 0;
          left: 0;
          right: 0;
          display: flex;
          justify-content: center;
          align-items: center;
          transform: translateY(24vmin);
          -webkit-transform: translateY(36vmin);
          backdrop-filter: blur(0.9vmin);
          -webkit-backdrop-filter: blur(0.9vmin);
          mask: linear-gradient(transparent, black 40%);
          -webkit-mask: linear-gradient(transparent, black 40%);
        }
        #bnsuffix {
          display: flex;
          align-items: center;
        }
        #bottomnav .hidden, #playeroverlay.hidden {
          display: none;
        }
        div.bnitem {
          width: 15.5vmin; height: 15.5vmin;
          padding: 2vmin;
          border: rgba(255,255,255,0.3) 1.0vmin solid;
          border-radius: 8vmin;
          margin: 0 2.0vmin 0 0;
          fill: rgba(255,255,255,0.6);
          stroke: rgba(255,255,255,0.6);
          cursor: pointer;
          background: rgba(0,0,0,0.5);
          -webkit-tap-highlight-color: rgba(0,0,0,0);
        }
        div.bnitem.active svg{
          filter: drop-shadow(0 0 0.2vmin rgb(255 255 255));
        }
        div.bnsep {
          margin: 0 3.5vmin 0 1vmin;
          background: rgba(255,255,255,0.3);
          height: 8vmin;
          width: 0.5vmin;
        }
        div.bnitem.active, div.bnitem:active {
          border-color: rgba(255,255,255,0.5);
          background: radial-gradient(rgba(255,255,255,0.3), rgba(255,255,255,0.1));
        }
        #player.slide-up #bottomnav {
          animation: slide-up 0.2s forwards;
          -webkit-animation: slide-up 0.2s forwards;
          z-index: 15;
        }
        #player.slide-dn #bottomnav {
          animation: slide-dn 0.2s forwards;
          -webkit-animation: slide-dn 0.2s forwards;
          z-index: 3;
        }
        
        @keyframes slide-in {
          100% { transform: translateX(0); }
        }
        @-webkit-keyframes slide-in {
          100% { -webkit-transform: translateX(0); }
        }
        @keyframes slide-out {
          0% { transform: translateX(0); }
          100% { transform: translateX(-60vmin); }
        }
        @-webkit-keyframes slide-out {
          0% { -webkit-transform: translateX(0); }
          100% { -webkit-transform: translateX(-60vmin); }
        }
        
        @keyframes player-in {
          100% { transform: translateX(60vmin); }
        }
        @-webkit-keyframes player-in {
          100% { -webkit-transform: translateX(60vmin); }
        }
        @keyframes player-out {
          0% { transform: translateX(60vmin); }
          100% { transform: translateX(0); }
        }
        @-webkit-keyframes player-out {
          0% { -webkit-transform: translateX(60vmin); }
          100% { -webkit-transform: translateX(0); }
        }
        
        @keyframes slide-up {
          100% { transform: translateY(0); }
        }
        @-webkit-keyframes slide-up {
          100% { -webkit-transform: translateY(0); }
        }
        @keyframes slide-dn {
          0% { transform: translateY(0); }
          100% { transform: translateY(30vmin); }
        }
        @-webkit-keyframes slide-dn {
          0% { -webkit-transform: translateY(0); }
          100% { -webkit-transform: translateY(30vmin); }
        }
        
        @media (orientation: landscape) {
          
        }
        @media (orientation: portrait) {
          #cover {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            margin-top: 1vmin;
          }
          #playerleft, #footer {
            position: absolute;
            right: 0;
            left: 0;
            z-index: 2;
          }
          #footer {
            right: 5vmin; left: 5vmin; bottom: 5vmin;
          }
          #genre {
            text-align: center;
            margin-top: 2vmin;
          }
          #playerprogresswrapper{
            margin-right: 0;
          }
          #timer {
            font-size: 10vmin;
            line-height: 10vmin;
          }
          #timers {
            display: none;
          }
          #timerwrapper {
            position: absolute;
            top: 0; right: 0;
          }
          #screensaver #timerwrapper {
            top: auto; right: auto;
            bottom: 27.5vmin;
          }
          #screensaver #timer {
            line-height: 25vmin;
          }
          #bnsuffix {
            display: none;
          }
        }
        @media (min-width: 400px) and (max-width: 1500px) and (orientation: landscape){
          #timer {
              font-size: 19vmin;
            }
            #timers {
              font-size: 9vmin;
            }
        }
        @media (min-width: 1500px) and (orientation: landscape) {
            #timer {
              font-size: 22vmin;
            }
            #timers {
              font-size: 10vmin;
            }
            #bottomnav {
              padding: 4vmin 1vmin 0vmin 1vmin;
            }
            div.bnitem {
              border-width: 0.5vmin;
              width: 14vmin; height: 14vmin;
              padding: 2.5vmin;
            }
        }
    </style>
</head>
<body>
    <div id="backdropwrap" class="transform"><img id="backdrop" alt=" " src=""></div>
    <div id="screensaver" class="hidden transform"></div>
    <div id="player" class="transform">
      <div id="title"><div></div></div>
      <div id="song"><div></div></div>
      <hr />
      <div id="centerwrap">
        <div id="playerleft">
          <div id="playstate" class="button" data-target="toggle"></div>
          <div id="genrewrap"><div id="genre"></div></div>
          <div id="timerwrapper">
            <div id="timer"></div>
            <div id="timers"></div>
          </div>
          <div id="playerprogresswrapper" class="hidden">
            <div id="playerprogressbg"><div id="playerprogress"></div></div>
            <div id="playerprogressduration"></div>
            <div id="playerprogresshandle" class="button" data-target="seek"></div>
          </div>
        </div>
        <div id="cover" class="button" data-target="navbartoggle">
          <img id="coverimg"  alt=" " src="" />
          <div id="favorite" class="button active" data-target="favorite" data-item="">
            <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
              <path d="M19.5 12.572l-7.5 7.428l-7.5 -7.428a5 5 0 1 1 7.5 -6.566a5 5 0 1 1 7.5 6.572" />
            </svg>
          </div>
        </div>
      </div>
      <div id="footer">
        <div id="infowrapper">
          <div id="volumetext"></div>
          <div id="bitrate"></div>
          <div id="ipaddr"></div>
        </div>
        <div id="volumebg"><div id="volume"></div></div>
      </div>
      <div id="bottomnav" class="transform">
        <div class="bnitem button" id="bnbutton0" data-target="playlisttoggle">
          <svg viewBox="0 0 24 24" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
            <path d="M14 17m-3 0a3 3 0 1 0 6 0a3 3 0 1 0 -6 0" />
            <path d="M17 17v-13h4" />
            <path d="M13 5h-10" />
            <path d="M3 9l10 0" />
            <path d="M9 13h-6" />
          </svg>
        </div>
        
        <div class="bnsep"></div>
        
        <div class="bnitem button" id="bnbutton1" data-target="mutetoggle">
          <svg id="bnunmuted" viewBox="0 0 24 24" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path d="M15 8a5 5 0 0 1 0 8" />
            <path d="M17.7 5a9 9 0 0 1 0 14" />
            <path d="M6 15h-2a1 1 0 0 1 -1 -1v-4a1 1 0 0 1 1 -1h2l3.5 -4.5a.8 .8 0 0 1 1.5 .5v14a.8 .8 0 0 1 -1.5 .5l-3.5 -4.5" />
          </svg>
          <svg id="bnmuted" class="hidden" viewBox="0 0 24 24" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path d="M15 8a5 5 0 0 1 1.912 4.934m-1.377 2.602a5 5 0 0 1 -.535 .464" />
            <path d="M17.7 5a9 9 0 0 1 2.362 11.086m-1.676 2.299a9 9 0 0 1 -.686 .615" />
            <path d="M9.069 5.054l.431 -.554a.8 .8 0 0 1 1.5 .5v2m0 4v8a.8 .8 0 0 1 -1.5 .5l-3.5 -4.5h-2a1 1 0 0 1 -1 -1v-4a1 1 0 0 1 1 -1h2l1.294 -1.664" />
            <path d="M3 3l18 18" />
          </svg>
        </div>

        <div class="bnitem button" id="bnbutton2" data-target="prev">
          <svg viewBox="0 0 24 24" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
            <path d="M21 5v14l-8 -7z" />
            <path d="M10 5v14l-8 -7z" />
          </svg>
        </div>

        <div class="bnitem button" id="bnbutton3" data-target="toggle">
          <svg id="navplay" viewBox="0 0 24 24" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path d="M7 4v16l13 -8z" />
          </svg>
          <svg  id="navpause" class="hidden" viewBox="0 0 24 24" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path d="M6 5m0 1a1 1 0 0 1 1 -1h2a1 1 0 0 1 1 1v12a1 1 0 0 1 -1 1h-2a1 1 0 0 1 -1 -1z" />
            <path d="M14 5m0 1a1 1 0 0 1 1 -1h2a1 1 0 0 1 1 1v12a1 1 0 0 1 -1 1h-2a1 1 0 0 1 -1 -1z" />
          </svg>
        </div>

        <div class="bnitem button" id="bnbutton4" data-target="next">
          <svg viewBox="0 0 24 24" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
            <path d="M3 5v14l8 -7z" />
            <path d="M14 5v14l8 -7z" />
          </svg>
        </div>
        <div id="bnsuffix">
          <div class="bnsep"></div>
          
          <div class="bnitem button" id="bnbutton5" data-target="randomtoggle">
            <svg id="bnrandom" class="hidden" viewBox="0 0 24 24" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path d="M18 4l3 3l-3 3" />
              <path d="M18 20l3 -3l-3 -3" />
              <path d="M3 7h3a5 5 0 0 1 5 5a5 5 0 0 0 5 5h5" />
              <path d="M21 7h-5a4.978 4.978 0 0 0 -3 1m-4 8a4.984 4.984 0 0 1 -3 1h-3" />
            </svg>
            <svg id="bnnotrandom" viewBox="0 0 24 24" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 17l-18 0" />
              <path d="M18 4l3 3l-3 3" />
              <path d="M18 20l3 -3l-3 -3" />
              <path d="M21 7l-18 0" />
            </svg>
          </div>

          <div class="bnitem button" id="bnbutton6" data-target="walkrepeat">
            <svg id="bnrepeat" class="hidden" viewBox="0 0 24 24" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
              <path d="M4 12v-3a3 3 0 0 1 3 -3h13m-3 -3l3 3l-3 3" />
              <path d="M20 12v3a3 3 0 0 1 -3 3h-13m3 3l-3 -3l3 -3" />
            </svg>
            <svg id="bnnorepeat" viewBox="0 0 24 24" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
              <path d="M4 12v-3c0 -1.336 .873 -2.468 2.08 -2.856m3.92 -.144h10m-3 -3l3 3l-3 3" />
              <path d="M20 12v3a3 3 0 0 1 -.133 .886m-1.99 1.984a3 3 0 0 1 -.877 .13h-13m3 3l-3 -3l3 -3" />
              <path d="M3 3l18 18" />
            </svg>
            <svg id="bnrepeatsingle" class="hidden" viewBox="0 0 24 24" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path d="M4 12v-3a3 3 0 0 1 3 -3h13m-3 -3l3 3l-3 3" />
              <path d="M20 12v3a3 3 0 0 1 -3 3h-13m3 3l-3 -3l3 -3" />
              <path d="M11 11l1 -1v4" />
            </svg>
            <svg id="bnsingle" class="hidden" viewBox="0 0 24 24" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path d="M11 11l1 -1v4" />
            </svg>
          </div>
        </div>
      </div><!-- bottomnav -->
      <div id="playeroverlay" class="hidden">
        <div class="bnitem button" data-target="playlisttoggle">
          <svg viewBox="0 0 24 24" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
            <path d="M18 6l-12 12" />
            <path d="M6 6l12 12" />
          </svg>
        </div>
        <div id="playlistmode" class="bnitem button" data-target="playlistmode">
          <svg viewBox="0 0 24 24" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 7l-18 0" />
            <path d="M18 10l3 -3l-3 -3" />
            <path d="M6 20l-3 -3l3 -3" />
            <path d="M3 17l18 0" />
          </svg>
        </div>
      </div>
    
    </div>
    <div id="playlist">
      <div id="playlistcontent">
        <ul id="playlistlist" class="hovered"></ul>
        <ul id="playlists" class="hovered hidden"></ul>
      </div>
      <div id="playlisthandle" class="button" data-target="playlisttoggle"></div>
    </div>
    <script>
        var hostname = window.location.search!=""?window.location.search.substring(1):window.location.hostname;
        var port='6601';
        var magick = parseInt(Math.random()*10000+40000);
        
        const KEY_LEFT  = ["ArrowLeft", "KeyA"];
        const KEY_RIGHT = ["ArrowRight", "KeyD"];
        const KEY_UP    = ["ArrowUp", "KeyW"]
        const KEY_DOWN  = ["ArrowDown", "KeyS"];
        const KEY_HOME  = ["BrowserHome", "Home", "KeyN", "Backquote"];
        const KEY_ENTER = ["Enter", "Space"];
        
        class Playlist {
          constructor() {
            this._content = getId("playlistcontent");
            this._list = getId("playlistlist");
            this._listall = getId("playlists");
            this._dog = undefined;
            this._currentsong = null;
            this._isplaying = false;
            this._modeall = false;
          }
          visible() {
            return document.body.hasClass('slide-in');
          }
          show(fromkeyboard=false){
            if(!this.visible()){
              document.body.classList.remove('slide-out');
              document.body.classList.add('slide-in');
              if(fromkeyboard){
                this._list.classList.remove('hovered');
                this._list.classList.add('notitles');
                this._listall.classList.remove('hovered');
                this._listall.classList.add('notitles');
              }
              websocket.send(JSON.stringify({"key": "LOCK", "code": true, "magick": magick}));
              this.startdog();
              navbar.hide();
              getId("playeroverlay").show();
              this.scrollto(this._currentsong);
            }
          }
          hide(silent=false){
            if(this.visible()){
              document.body.classList.remove('slide-in');
              document.body.classList.add('slide-out');
              this.stopdog();
              getId("playeroverlay").hide();
              if(this._modeall) this.changemode();
              if(!silent)
                setTimeout(()=>{
                  websocket.send(JSON.stringify({"key": "LOCK", "code": false, "magick": magick}));
                }, 500);
            }
          }
          toggle(){
            if(this.visible()) this.hide(); else this.show();
            return this.visible();
          }
          clear(){
            this._list.textContent='';
          }
          current(val=null){
            if(val!=null){
              if(this._list.childElementCount>0) if(val>this._list.childElementCount-1) val=this._list.childElementCount-1;
              if(val<0) val=0;
              this._currentsong=val;
              if(this.visible()) this.scrollto(this._currentsong);
            }else{
              return this._currentsong;
            }
          }
          isplaying(val=undefined){
            if(val!==undefined){
              this._isplaying=val;
            }
            return this._isplaying;
          }
          additem(jitem){
            let song = jitem.song?jitem.song+' ':'';
            let genre = jitem.genre?'['+jitem.genre+']':'';
            let duration = jitem.duration?' '+jitem.duration:'';
            let plitem = document.createElement('li');
            plitem.attr('class', 'plitem');
            plitem.attr('id', `plitem${jitem.id}`);
            plitem.dataset.target = 'play';
            plitem.dataset.payload = jitem.id;
            plitem.attr('style', `background-image: url(http://${hostname}/${jitem.cover})`);
            plitem.innerHTML=`<div class="plname" title="${jitem.title}">${jitem.title}</div> <div class="plgenre">${song}${genre}${duration}</div>`;
            plitem.addEventListener("mouseup", this.itemclick.bind(plitem), false);
            this._list.appendChild(plitem);
          }
          alllist(list){
            getId("playlists").textContent='';
            list.forEach((item, id) => {
              let plitem = document.createElement('li');
              plitem.attr('class', 'plitem');
              plitem.attr('id', `list${id}`);
              plitem.dataset.target = 'loadplaylist';
              plitem.dataset.payload = item.playlist;
              plitem.attr('style', `background-image: url(http://${hostname}/imagesw/playlist-covers/${encodeURI(item.playlist)}.jpg)`);
              plitem.innerHTML=`<div class="plname" title="${item.playlist}">${item.playlist}</div>`;
              plitem.addEventListener("mouseup", this.playlistclick.bind(plitem), false);
              getId("playlists").appendChild(plitem);
            });
          }
          changemode(){
            if(this._list.classList.contains("hidden")) {
              this._list.classList.remove("hidden");
              this._listall.classList.add("hidden");
              this.scrollto();
              this._modeall=false;
            }else{
              this._list.classList.add("hidden");
              this._listall.classList.remove("hidden");
              this._modeall=true;
            }
          }
          itemclick(event){
            event = event || window.event;
            if(event.button!==0) return;
            let payload = this.dataset.payload;
            if(payload) {
              websocket.send(JSON.stringify({"cmd": "play", 'payload': payload}));
              playlist.hide();
            }
          }
          playlistclick(event){
            event = event || window.event;
            if(event.button!==0) return;
            let payload = this.dataset.payload;
            if(payload) {
              websocket.send(JSON.stringify({"cmd": "loadpl", 'payload': payload}));
              playlist.hide();
            }
          }
          scrollto(id=null){
            if(id==null) id=this._currentsong;
            this._currentsong = id;
            let plitem=getId('plitem'+id);
            let plitems = getClass('plitem', this._list);
            for (let item of plitems) {
              item.classList.remove('active');
            }
            if(plitem){
              plitem.classList.add('active');
              let topPos = plitem.offsetTop;
              let lih = plitem.offsetHeight;
              let plh = this._content.offsetHeight;
              let plt = this._content.offsetTop;
              this._content.scrollTo({
                top: topPos-plt-plh/2+lih/2,
                left: 0,
                behavior: 'smooth'
              });
            }
          }
          stopdog(){
            if(this._dog) clearTimeout(this._dog);
          }
          startdog(){
            if(this._dog) clearTimeout(this._dog);
            this._dog=setTimeout(()=>{
              if(this.visible()){
                playlist.hide();
                websocket.send(JSON.stringify({"key": "LOCK", "code": false, "magick": magick}));
              }
            }, 1000*30);
          }
          walk(key){
            if(KEY_UP.includes(key) || KEY_DOWN.includes(key)){
              let nextindex = getElementIndex(getClass("active", this._list)[0]);
              if(KEY_UP.includes(key)) nextindex -=1;
              if(KEY_DOWN.includes(key)) nextindex +=1;
              if(nextindex>this._list.childElementCount-1) nextindex=0;
              if(nextindex<0) nextindex=this._list.childElementCount-1;
              let ni = getClass("plitem", this._list)[nextindex].dataset.payload;
              this.scrollto(ni);
              this.startdog();
            }
            if(KEY_RIGHT.includes(key) || KEY_LEFT.includes(key)){
              this.hide();
              this.stopdog();
            }
            if(KEY_ENTER.includes(key)){
              controlsLock();
              websocket.send(JSON.stringify({"cmd": "play", 'payload': playlist.current()}));
              this.hide();
            }
          }
          _handleclick(event){
            if(!x0) this.hide();
            x0 = null;
            event.stopPropagation();
            return false;
          }
        } /* end of Playlist */
        /*****************************************************************/
        class Navbar {
          constructor(){
            this._player = getId("player");
            this._parent = getId("bottomnav");
            this._count = getClass("button", this._parent).length;
            this._current = 3;
            this._dog = undefined;
          }
          visible() {
            return this._player.hasClass('slide-up');
          }
          show(){
            if(!this.visible()){
              this._player.classList.remove('slide-dn');
              this._player.classList.add('slide-up');
              getId("bnbutton"+this._current).classList.add("active");
              websocket.send(JSON.stringify({"key": "LOCK", "code": true, "magick": magick}));
              this.startdog();
            }
          }
          hide(silent=false){
            if(this.visible()){
              this._player.classList.remove('slide-up');
              this._player.classList.add('slide-dn');
              if(!silent)
                setTimeout(()=>{
                  if(!playlist.visible()) websocket.send(JSON.stringify({"key": "LOCK", "code": false, "magick": magick}));
                }, 500);
              this.setallinactive();
              this._current = 3;
            }
            this.stopdog();
          }
          toggle(){
            if(this.visible()) this.hide(); else this.show();
            return this.visible();
          }
          stopdog(){
            if(this._dog) clearTimeout(this._dog);
          }
          startdog(){
            if(this._dog) clearTimeout(this._dog);
            this._dog=setTimeout(()=>{
              if(this.visible()){
                this.hide();
              }
            }, 1000*30);
          }
          walk(key){
            if(KEY_UP.includes(key) || KEY_DOWN.includes(key)){
              this.hide();
            }
            if(KEY_ENTER.includes(key)){
              let target = this.getactive().dataset.target;
              if(target=="playlisttoggle"){
                this.hide();
                playlist.show(true);
              }else{
                controlsLock();
                websocket.send(JSON.stringify({"cmd": target, 'payload': ''}));
                if(target=="toggle") this.hide();
              }
            }
            if(KEY_RIGHT.includes(key) || KEY_LEFT.includes(key)){
              this.getnext(KEY_RIGHT.includes(key));
              this.startdog();
            }
          }
          getactive(){
            let out = undefined;
            classEach("button", this._parent, (item, index)=>{
              if(item.hasClass("active")) {
                out = item;
                this._current = index;
              }
            });
            return out;
          }
          setallinactive(){
            classEach("button", this._parent, (item, index)=>{
              item.classList.remove("active");
            });
          }
          getnext(forward){
            this._current = forward?this._current+1:this._current-1;
            if(this._current<0) this._current=this._count-1;
            if(this._current>this._count-1) this._current=0;
            this.setallinactive();
            let nextel = getId("bnbutton"+this._current);
            if(nextel.offsetParent === null) {
              this.getnext(forward);
              return;
            }
            nextel.classList.add("active");
          }
        } /* end of Navbar */
        /*****************************************************************/
        class Screensaver {
          constructor(){
            this._clock      = getId("timerwrapper");
            this._root       = getId("screensaver");
            this._prevParent = getId("playerleft");
            this._before     = progress.root();
            this._timer      = null;
            this._interval   = 5; //minutes
            this._root.addEventListener('click', this.resume.bind(this), false);
          }
          start(){
            if(this._timer) clearTimeout(this._timer);
            this._timer = setTimeout(() => {
              this._root.appendChild(this._clock);
              this._root.classList.remove('hidden');
              playlist.hide();
              navbar.hide();
            }, this._interval*1000*60);
          }
          stop(){
            if(this._timer) clearTimeout(this._timer);
            this._timer      = null;
            this._root.classList.add('hidden');
            this._prevParent.insertBefore(this._clock, this._before);
          }
          resume(event){
            this.stop()
            if(event) {
              event.stopPropagation();
            }
            if(!playlist.isplaying()) this.start();
          }
          visible(){
            return !this._root.classList.contains('hidden')
          }
        } /* end of Screensaver */
        /*****************************************************************/
        class wsClient {
          constructor(host, port){
            this._host  = host;
            this._port  = port;
            this._timer = undefined;
            this._ws    = undefined;
            this._errors = 0;
            this._fasterrors = 60;
            this.connect();
            this._currenttime='';
            this._imghash = '';
            this._eltimers = getId('timers');
          }
          connect(){
            if(this._timer) clearTimeout(this._timer);
            let uri = `ws://${this._host}:${this._port}/`;
            console.log(`Trying to open a WebSocket connection to ${uri}`);
            this._ws = new WebSocket(uri);
            this._ws.onopen    = this.onopen.bind(this);
            this._ws.onclose   = this.onclose.bind(this);
            this._ws.onmessage = this.onmessage.bind(this);
          }
          onopen(event){
            console.log('Connection opened');
            if(this._host=='localhost') this.send(JSON.stringify({"localhost": magick}))
            this._errors=0;
          }
          onclose(event){
            this._errors++;
            console.log('Connection closed');
            this._timer=setTimeout(this.connect.bind(this), this._errors<this._fasterrors?2000:120000);
          }
          dataescape(data){
            let m=data.match(/{.+?:\s"(.+?)"}/);
            if(m!==null){
              let m1 = m[1];
              if(m1.indexOf('"') !== -1){
                let mq=m1.replace(/["]/g, '\\\"');
                return data.replace(m1,mq);
              }
            }
            return data;
          }
          onmessage(event){
            //var data = JSON.parse(this.dataescape(event.data));
            var data = JSON.parse(event.data);
            if(!data) return;
            if("displayname" in data){
                title.text(data.displayname);
                if(data.format==''){
                  getId("bitrate").textContent=data.bitrate!=''?data.bitrate+' kbps':'';
                }else{
                  getId("bitrate").textContent=data.bitrate!=''?data.bitrate+' '+data.format:'';
                }
                getId("genre").textContent=data.genre;
                if(this._imghash!=data.imghash){
                  this._imghash=data.imghash;
                  getId("coverimg").src = `http://${hostname}/${data.coverurl}`;
                }
                song.text((data.title=='')?'Streaming source':data.title);
                getId("playstate").textContent = data.state;
                if(typeof volbar!='undefined') volbar.set(data.volume);
                getId("ipaddr").textContent = data.ip;
                playlist.current(data.id);
                lockControls = false;
                if(playlist.isplaying(data.state=='play')){
                  screensaver.resume(null);
                  getId("navplay").classList.add("hidden");
                  getId("navpause").classList.remove("hidden");
                }else{
                  screensaver.start();
                  getId("navpause").classList.add("hidden");
                  getId("navplay").classList.remove("hidden");
                }
                if(data.mute){
                  getId("bnunmuted").classList.add("hidden");
                  getId("bnmuted").classList.remove("hidden");
                }else{
                  getId("bnmuted").classList.add("hidden");
                  getId("bnunmuted").classList.remove("hidden");
                }
                if(data.random){
                  getId("bnnotrandom").classList.add("hidden");
                  getId("bnrandom").classList.remove("hidden");
                }else{
                  getId("bnrandom").classList.add("hidden");
                  getId("bnnotrandom").classList.remove("hidden");
                }
                getId("bnrepeat").classList.add("hidden");
                getId("bnnorepeat").classList.add("hidden");
                getId("bnrepeatsingle").classList.add("hidden");
                getId("bnsingle").classList.add("hidden");
                if(data.repeat && data.single) getId("bnrepeatsingle").classList.remove("hidden");
                if(data.repeat && !data.single) getId("bnrepeat").classList.remove("hidden");
                if(!data.repeat && data.single) getId("bnsingle").classList.remove("hidden");
                if(!data.repeat && !data.single) getId("bnnorepeat").classList.remove("hidden");
                timers.sync(data.serverms, data.elapsed, data.duration, data.local);
                getId("favorite").dataset.item=data.file;
                if(data.favorite) getId("favorite").classList.add("active")
                else getId("favorite").classList.remove("active")
            }
            if("playlist" in data){
              playlist.clear();
              data.playlist.forEach((plitem) => {
                playlist.additem(plitem);
              });
              playlist.scrollto();
              playlist.alllist(data.all);
            }
            if("time" in data){
              timers.sync(data.time, 0, 0, data.local);
            }
            if("magick" in data){
              if(data.magick!=magick){
                playlist.hide(true);
                navbar.hide(true);
              }
            }
          }//onmessage
          send(data){
            this._ws.send(data);
          }
        } /* end of wsClient */
        /*****************************************************************/
        class Progress {
          constructor(){
            this._progress = getId("playerprogress");
            this._duration = getId("playerprogressduration");
            this._root = getId("playerprogresswrapper");
            this._handle = getId("playerprogresshandle");
            this._prevv = 0;
            this._prevd = 0;
          }
          set(value, duration, display=false) {
            value = parseFloat(value);
            if(value!=this._prevv) this._progress.attr('style', 'width: '+value+'%;');
            if(duration!=this._prevd) this._duration.textContent=duration;
            this._prevv=value;
            this._prevd=duration;
            if(value==0 && duration=='') {
              this.hide();
              return;
            }
            if(display) this.show();
          }
          root(){
            return this._root;
          }
          visible(){
            return !this._root.hasClass('hidden');
          }
          hide(){
            if(this.visible()) this._root.classList.add('hidden');
          }
          show(){
            if(!this.visible()) this._root.classList.remove('hidden');
          }
          seek(event){
            let payload=((100*(unify(event).clientX-getId("centerwrap").offsetLeft)/this._handle.clientWidth) | 0);
            console.log(unify(event).clientX);
            console.log();
            console.log(this._handle.clientWidth);
            this._progress.attr('style', 'width: '+payload+'%;');
            return payload;
          }
        } /* end of Progress */
        /*****************************************************************/
        class Volbar {
          constructor(){
            this._root   = getId("volumebg");
            this._slider = getId("volume");
            this._volume = 0;
            this._current = 0;
            this._text   = getId("volumetext");
            this._locked = false;
            this._root.addEventListener("mousedown", this._lock.bind(this), false);
            this._root.addEventListener("touchstart", this._lock.bind(this), false);
            this._root.addEventListener("mousemove", this._move.bind(this), false);
            this._root.addEventListener("touchmove", this._move.bind(this), false);
            this._root.addEventListener("mousewheel", this._whell.bind(this), false);
            this._timer = undefined;
          }
          get(){
            return this._volume;
          }
          set(val){
            //val=parseInt(val);
            //this._volume=val<0?0:val>100?100:val;
            this._volume=val;
            this._slider.attr('style','width: '+this._volume+'%;');
            this._text.textContent=this._volume+'%';
          }
          locked(){
            return this._locked;
          }
          _changed(){
            return this._volume!=this._current;
          }
          _send(){
            if(!this._changed()) return;
            this._current=this._volume;
            websocket.send(JSON.stringify({"cmd": "vol", "value": this._volume}));
          }
          _lock(event){
            event = event || window.event;
            event.preventDefault();
            document.addEventListener("mouseup", this._unlock.bind(this), { once: true, capture: true });
            document.addEventListener("touchend", this._unlock.bind(this), { once: true, capture: true });
            this._locked = true;
            this._volume=((100*(unify(event).clientX-this._slider.offsetLeft)/this._root.clientWidth) | 0);
            this.set(this._volume);
          }
          _unlock(event){
            event = event || window.event;
            event.preventDefault();
            if(event.constructor.name=='MouseEvent' && event.button!==0) return;
            if(this._changed()) this._send();
            this._locked = false;
          }
          _move(event){
            event = event || window.event;
            event.preventDefault();
            if(!this._locked) return;
            this._volume=((100*(unify(event).clientX-this._slider.offsetLeft)/this._root.clientWidth) | 0);
            this.set(this._volume);
          }
          _whell(event){
            if(this._timer) clearTimeout(this._timer);
            this._volume -= Math.sign(event.deltaY);
            
            this.set(this._volume);
            this._timer = setTimeout(this._send.bind(this),1000);
          }
        } /* end of Volbar */
        /*****************************************************************/
        class Swiper {
          constructor () {
            this._touchX = null;
            this._touchY = null;
            this._detect = 50;
            this._stop   = false;
            document.addEventListener('mousedown', this._lock.bind(this), false);
            document.addEventListener('touchstart', this._lock.bind(this), false);
            document.addEventListener('mousemove', this._move.bind(this), false);
            document.addEventListener('touchmove', this._move.bind(this), false);
          }
          _lock(event){
            event = event || window.event;
            //event.preventDefault();
            this._touchX = unify(event).clientX;
            this._touchY = unify(event).clientY;
            document.addEventListener("mouseup", this._unlock.bind(this), { once: true, capture: true });
            document.addEventListener("touchend", this._unlock.bind(this), { once: true, capture: true });
          }
          _unlock(event){
            event = event || window.event;
            //event.preventDefault();
            if(event && this._stop){
              event = event || window.event;
              event.stopPropagation();
              this._stop = false;
            }
            this._touchX = null;
            this._touchY = null;
          }
          _detected(c){
            return (c>this._detect || c<-this._detect);
          }
          _move(event){
            event = event || window.event;
            //event.preventDefault();
            if (volbar.locked()) this._unlock();
            if(this._touchX!=null && this._touchY!=null) {
              let dx = unify(event).clientX-this._touchX;
              let dy = unify(event).clientY-this._touchY;
              if(this._detected(dx)){
                this._unlock();
                this._stop = true;
                if(dx>this._detect) playlist.show();
                if(dx<-this._detect) playlist.hide();
              }else if(this._detected(dy) && !playlist.visible()){
                this._unlock();
                this._stop = true;
                if(dy>this._detect) navbar.hide();
                if(dy<-this._detect) navbar.show();
              }
            }
          }
        } /* end of Swiper */
        /*****************************************************************/
        class Scroller {
          constructor(slave, step = 5, repeatafter=0){
            this._child  = slave.children[0];
            this._step = slave.offsetWidth/100;
            this._step = step;
            this._repeatafter = repeatafter;
            this.RAF = null;
            this.STO = null;
          }
          text(val){
            this._child.textContent = val;
            this._scrollwidth = 0;
            this._offset = 0;
            this._reset();
            
            if(this._child.scrollWidth-this._child.offsetWidth>0){
              let text = this._child.textContent;
              this._child.innerHTML = `${text}&nbsp;&bull;&nbsp;`;
              this._scrollwidth = this._child.scrollWidth;
              this._child.innerHTML += text;
              this.RAF=requestAnimationFrame(this._scrolltext.bind(this));
            }
          }
          _dorepeat(){
            this.RAF=requestAnimationFrame(this._scrolltext.bind(this));
          }
          _scrolltext(timeStamp){
            this._offset -= this._scrollwidth+this._offset<this._step*5?1:this._step;
            this._child.attr('style', `transform: translate3d(${this._offset}px,0,0);`);
            if(this._scrollwidth+this._offset<=0 || screensaver.visible()) {
              this._stop();
              return;
            }
            this.RAF=requestAnimationFrame(this._scrolltext.bind(this));
          }
          _reset(){
            if(this.RAF) cancelAnimationFrame(this.RAF);
            if(this.STO) clearTimeout(this.STO);
            this._child.attr('style', 'transform: translateX(0);');
            this._offset = 0;
            this.RAF = null;
            this.STO = null;
          }
          _stop(){
            this._reset();
            if(this._child.scrollWidth-this._child.offsetWidth>0 && this._repeatafter>0) this.STO = setTimeout(this._dorepeat.bind(this), this._repeatafter*1000);
          }
        } /* end of Scroller */
        /*****************************************************************/
        class Timers {
          constructor(){
            this._time = getId("timer");
            this._times = getId("timers");
            this._ms = 0;
            this._elapsed = 0;
            this._duration = 0;
            this._local = false;
            this.timer = setInterval(this._process.bind(this), 1000);
          }
          _mstotime(s) {
            function pad(n, z) {
              z = z || 2;
              return ('00' + n).slice(-z);
            }
            var ms = s % 1000;
            s = (s - ms) / 1000;
            var secs = s % 60;
            s = (s - secs) / 60;
            var mins = s % 60;
            var hrs = (s - mins) / 60;
            //return pad(hrs) + ':' + pad(mins) + ':' + pad(secs) + '.' + pad(ms, 3);
            return pad(mins) + ':' + pad(secs);
          }
          _process(){
            this._ms+=1000;
            const d = new Date(this._ms);
            const dd = [d.getHours(), d.getMinutes()].map((a)=>(a < 10 ? '0' + a : a));
            let ds = d.getSeconds();
            ds=ds<10?'0'+ds:ds;
            if(this._local && playlist.isplaying()){
              this._time.textContent = this._mstotime(this._elapsed);
              this._times.textContent = '';
            }else{
              this._time.textContent = dd.join(':');
              this._times.textContent = ds;
            }
            this._progress();
          }
          _progress(){
            if(this._local && playlist.isplaying()){
              progress.set(this._elapsed*100/this._duration, this._mstotime(this._duration), true);
              this._elapsed+=1000;
            }else{
              progress.set(0, '');
            }
          }
          sync(time, elapsed, duration, local){
            this._ms = time;
            this._elapsed = elapsed;
            this._duration = duration;
            this._local = local;
            this._process();
          }
        }
        var title = new Scroller(getId("title"), 5, 10);
        var song  = new Scroller(getId("song"), 3, 5);
        var swiper = new Swiper();
        var volbar = new Volbar();
        var progress = new Progress();
        var screensaver = new Screensaver();
        var playlist = new Playlist();
        var navbar    = new Navbar();
        var websocket = new wsClient(hostname, port);
        var timers = new Timers();

        var lockControls = false; // wait for moode feedback
        function controlsLock(){
          lockControls=true;
          setTimeout(() => {
            lockControls=false;
          }, 10000);
        }
        
        HTMLElement.prototype.hasClass = function (className) {
          return this.classList.contains(className);
        }
        HTMLElement.prototype.active = function () {
          return this.classList.contains("active");
        }
        HTMLElement.prototype.show = function () {
          this.classList.remove("hidden");
        }
        HTMLElement.prototype.hide = function () {
          this.classList.add("hidden");
        }
        HTMLElement.prototype.attr = function (name, value="") {
          if(value=="")
            return this.getAttribute(name);
          else
            this.setAttribute(name, value);
          return true;
        }
        function getId(elementId){
          return document.getElementById(elementId);
        }
        function getClass(elementClass, parent=document){
          return Array.from(parent.getElementsByClassName(elementClass));
        }
        function classEach(className, parent, callback){
          getClass(className, parent).forEach((el, n) => callback(el, n));
        }
        function getElementIndex (element) {
          return Array.from(element.parentNode.children).indexOf(element);
        }
        function unify(event) {
          return event.changedTouches ? event.changedTouches[0] : event;
        }

        document.body.addEventListener("keyup", (event)=>{
          event = event || window.event;
          console.log(`{event='keyup', key='${event.key}', code='${event.code}'}`);
          screensaver.resume(null);
          if(KEY_HOME.includes(event.code)){
            if(!navbar.visible() && playlist.visible()){
              playlist.hide();
              return false;
            }
            if(navbar.visible() && !playlist.visible()){
              navbar.hide();
              playlist.show(true);
              return false;
            }
            if(!navbar.visible() && !playlist.visible()){
              navbar.show();
              return false;
            }
          }
          if(playlist.visible()) playlist.walk(event.code);
          if(navbar.visible()) navbar.walk(event.code);
          let msg='';
          if(KEY_ENTER.includes(event.code)) msg="enter";
          if(KEY_LEFT.includes(event.code)) msg="prev";
          if(KEY_RIGHT.includes(event.code)) msg="next";
          if(KEY_UP.includes(event.code)) msg="up";
          if(KEY_DOWN.includes(event.code)) msg="down";
          websocket.send(JSON.stringify({"key": event.key, "code": event.code, "magick": magick, "msg": msg}));
        }, false);
        
        classEach("button", document, (button, i)=>{
          button.addEventListener("mouseup", (event)=>{
            if(event.button!==0) return;
            screensaver.resume(null);
            let cmd=button.dataset.target;
            
            if(cmd=="favorite"){
              event.stopPropagation();
              button.classList.toggle("active");
              websocket.send(JSON.stringify({"cmd": "favorite", 'payload': button.dataset.item, 'action': button.classList.contains('active')?'add':'remove'}));
              //console.log(button.dataset.item);
              return;
            }
            if(cmd=="toggle") navbar.hide();
            let payload=button.dataset.payload;
            payload=payload?payload:'';
            console.log(`{event='mouseup', target='${button.dataset.target}', payload='${payload}'}`);
            if(cmd=="playlisttoggle"){
              playlist.toggle();
              event.stopPropagation();
              return false;
            }
            if(cmd=="playlistmode"){
              playlist.changemode();
              event.stopPropagation();
              return false;
            }
            if(cmd=="navbartoggle"){
              navbar.toggle();
              return false;
            }
            if(cmd=="seek"){
              payload=progress.seek(event);
            }
            if(lockControls && !cmd) return;
            controlsLock();
            if(navbar.visible()) navbar.startdog();
            if(cmd) websocket.send(JSON.stringify({"cmd": cmd, 'payload': payload}));
            event.stopPropagation();
          }, false);
        });
        getId("coverimg").onload = function(){
          getId("backdrop").src = this.src;
        }
    </script>
</body>
</html>
